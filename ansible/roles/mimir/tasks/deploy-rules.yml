---
# Deploy Mimir rules via the Mimir ruler API
# Can be included from the main role or run standalone via the rules playbook
#
# Mimir ruler API: POST /prometheus/config/v1/rules/{namespace}
# Body: a single bare rule group YAML (without the top-level "groups:" key)
# Header: X-Scope-OrgID (use "anonymous" since multitenancy is disabled)
#
# Rule files are kept in standard Prometheus format (with a "groups:" wrapper)
# for compatibility with mimirtool validation.  The inline Jinja2 filter
# strips the wrapper before POSTing each group individually.

- name: Find all Mimir alert rule files
  ansible.builtin.find:
    paths: "{{ role_path }}/files/rules/alerts"
    patterns: "*.yml"
  delegate_to: localhost
  become: false
  register: mimir_alert_rule_files

- name: Find all Mimir recording rule files
  ansible.builtin.find:
    paths: "{{ role_path }}/files/rules/recording"
    patterns: "*.yml"
  delegate_to: localhost
  become: false
  register: mimir_recording_rule_files

- name: Build flat list of (file, group) pairs for upload
  ansible.builtin.set_fact:
    mimir_rule_groups: >-
      {%- set result = [] -%}
      {%- for f in mimir_alert_rule_files.files + mimir_recording_rule_files.files -%}
        {%- set parsed = lookup('file', f.path) | from_yaml -%}
        {%- for g in parsed.groups | default([]) -%}
          {%- set _ = result.append({'namespace': f.path | basename | regex_replace('\.yml$', ''), 'group': g}) -%}
        {%- endfor -%}
      {%- endfor -%}
      {{ result }}

- name: Push Mimir rules via ruler API
  ansible.builtin.uri:
    url: "http://{{ ansible_host }}:{{ mimir_http_port }}/prometheus/config/v1/rules/{{ item.namespace }}"
    method: POST
    headers:
      Content-Type: "application/yaml"
      X-Scope-OrgID: "anonymous"
    body: "{{ item.group | to_nice_yaml }}"
    body_format: raw
    status_code: [202]
    return_content: true
  register: mimir_push_result
  loop: "{{ mimir_rule_groups }}"
  loop_control:
    label: "{{ item.namespace }} / {{ item.group.name }}"
  when: mimir_rule_groups | length > 0

- name: Verify Mimir rules were loaded
  ansible.builtin.uri:
    url: "http://{{ ansible_host }}:{{ mimir_http_port }}/prometheus/api/v1/rules"
    method: GET
    headers:
      X-Scope-OrgID: "anonymous"
    return_content: true
    status_code: 200
  register: mimir_rules_check

- name: Display loaded Mimir rule groups
  ansible.builtin.debug:
    msg: "Mimir rules loaded: {{ mimir_rules_check.json.data.groups | default([]) | map(attribute='name') | list }}"
  when: mimir_rules_check.json.data.groups is defined
