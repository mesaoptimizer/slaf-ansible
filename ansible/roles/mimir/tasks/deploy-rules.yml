---
# Deploy Mimir rules via the Mimir ruler API
# Can be included from the main role or run standalone via the rules playbook
#
# Mimir ruler API: POST /api/v1/rules/{namespace}
# Body: YAML rule group file
# Header: X-Scope-OrgID (use "anonymous" since multitenancy is disabled)

- name: Find all Mimir alert rule files
  ansible.builtin.find:
    paths: "{{ role_path }}/files/rules/alerts"
    patterns: "*.yml"
  delegate_to: localhost
  become: false
  register: mimir_alert_rule_files

- name: Find all Mimir recording rule files
  ansible.builtin.find:
    paths: "{{ role_path }}/files/rules/recording"
    patterns: "*.yml"
  delegate_to: localhost
  become: false
  register: mimir_recording_rule_files

- name: Set combined rule files list
  ansible.builtin.set_fact:
    mimir_all_rule_files: "{{ mimir_alert_rule_files.files + mimir_recording_rule_files.files }}"

- name: Push Mimir rules via ruler API
  ansible.builtin.uri:
    url: "http://{{ ansible_host }}:{{ mimir_http_port }}/api/v1/rules/{{ item.path | basename | regex_replace('\\.yml$', '') }}"
    method: POST
    headers:
      Content-Type: "application/yaml"
      X-Scope-OrgID: "anonymous"
    body: "{{ lookup('file', item.path) }}"
    status_code: [200, 202]
  loop: "{{ mimir_all_rule_files }}"
  loop_control:
    label: "{{ item.path | basename }}"
  when: mimir_all_rule_files | length > 0

- name: Verify Mimir rules were loaded
  ansible.builtin.uri:
    url: "http://{{ ansible_host }}:{{ mimir_http_port }}/api/v1/rules"
    method: GET
    headers:
      X-Scope-OrgID: "anonymous"
    return_content: true
    status_code: 200
  register: mimir_rules_check

- name: Display loaded Mimir rule groups
  ansible.builtin.debug:
    msg: "Mimir rules loaded: {{ mimir_rules_check.json.data.groups | default([]) | map(attribute='name') | list }}"
  when: mimir_rules_check.json.data.groups is defined
