---
- name: Install Mimir dependencies
  community.general.apk:
    name:
      - curl
      - ca-certificates
      - libcap
    state: present
    update_cache: true

- name: Create mimir system group
  ansible.builtin.group:
    name: mimir
    system: true
    state: present

- name: Create mimir system user
  ansible.builtin.user:
    name: mimir
    group: mimir
    shell: /sbin/nologin
    home: /var/lib/mimir
    createhome: true
    system: true
    state: present

- name: Create mimir directories
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    owner: mimir
    group: mimir
    mode: "0750"
  loop:
    - /var/lib/mimir
    - /var/lib/mimir/tsdb
    - /var/lib/mimir/compactor
    - /var/lib/mimir/rules
    - /var/lib/mimir/rules/anonymous
    - /var/lib/mimir/rules-temp
    - /var/lib/mimir/alertmanager
    - /var/lib/mimir/tsdb-sync
    - /etc/mimir

- name: Download Mimir binary
  block:
    - name: Get latest Mimir release
      ansible.builtin.uri:
        url: https://api.github.com/repos/grafana/mimir/releases/latest
        return_content: true
      register: mimir_release
      check_mode: false

    - name: Extract download URL for Linux amd64
      ansible.builtin.set_fact:
        mimir_download_url: "{{ mimir_release.json.assets | selectattr('name', 'match', 'mimir-linux-amd64') | map(attribute='browser_download_url') | first }}"

    - name: Download Mimir binary
      ansible.builtin.get_url:
        url: "{{ mimir_download_url }}"
        dest: /usr/local/bin/mimir
        mode: "0755"
        owner: root
        group: root
      register: mimir_binary_download

- name: Retrieve AppRole credentials from Vault
  block:
    - name: Get AppRole credentials from Vault for mimir
      ansible.builtin.uri:
        url: "{{ vault_addr }}/v1/secret/data/approle/mimir"
        method: GET
        headers:
          X-Vault-Token: "{{ vault_token }}"
        status_code: 200
        validate_certs: false
      register: mimir_approle_credentials_result
      check_mode: false

    - name: Set AppRole credentials from Vault
      ansible.builtin.set_fact:
        mimir_vault_role_id: "{{ mimir_approle_credentials_result.json.data.data.role_id }}"
        mimir_vault_secret_id: "{{ mimir_approle_credentials_result.json.data.data.secret_id }}"
        cacheable: true
      when: mimir_approle_credentials_result.json.data.data.role_id is defined

- name: Retrieve S3 credentials from Vault using AppRole
  block:
    - name: Authenticate with Vault using AppRole
      ansible.builtin.uri:
        url: "{{ vault_addr }}/v1/auth/approle/login"
        method: POST
        body_format: json
        body:
          role_id: "{{ mimir_vault_role_id }}"
          secret_id: "{{ mimir_vault_secret_id }}"
        status_code: 200
        validate_certs: false
      register: mimir_vault_auth_result
      check_mode: false

    - name: Retrieve S3 credentials from Vault
      ansible.builtin.uri:
        url: "{{ vault_addr }}/v1/secret/data/garage/mimir/credentials"
        method: GET
        headers:
          X-Vault-Token: "{{ mimir_vault_auth_result.json.auth.client_token }}"
        status_code: 200
        validate_certs: false
      register: mimir_s3_credentials_result
      check_mode: false

    - name: Set S3 credentials fact
      ansible.builtin.set_fact:
        mimir_s3_access_key: "{{ mimir_s3_credentials_result.json.data.data.access_key_id }}"
        mimir_s3_secret_key: "{{ mimir_s3_credentials_result.json.data.data.secret_access_key }}"
        mimir_s3_bucket: "{{ mimir_s3_credentials_result.json.data.data.bucket_name | default('mimir') }}"
        cacheable: true

- name: Generate Mimir configuration
  ansible.builtin.template:
    src: mimir-config.yml.j2
    dest: /etc/mimir/mimir-config.yml
    owner: mimir
    group: mimir
    mode: "0640"
  notify: Restart mimir

- name: Create mimir log file
  ansible.builtin.file:
    path: /var/log/mimir.log
    state: touch
    owner: mimir
    group: mimir
    mode: "0644"
    modification_time: preserve
    access_time: preserve

- name: Create Mimir systemd service
  ansible.builtin.template:
    src: mimir.service.j2
    dest: /etc/init.d/mimir
    mode: "0755"
  notify: Restart mimir

- name: Enable and start Mimir service
  ansible.builtin.service:
    name: mimir
    state: started
    enabled: true

- name: Wait for Mimir to be ready
  ansible.builtin.wait_for:
    host: localhost
    port: "{{ mimir_http_port }}"
    delay: 2
    timeout: 60
    state: started

- name: Check Mimir ready endpoint
  ansible.builtin.uri:
    url: "http://localhost:{{ mimir_http_port }}/ready"
    method: GET
    status_code: 200
  retries: 10
  delay: 2
  register: mimir_ready_result
  until: mimir_ready_result.status == 200

- name: Verify Mimir is running
  ansible.builtin.command: /usr/bin/pgrep -f mimir
  register: mimir_process
  changed_when: false
  failed_when: mimir_process.rc != 0

- name: Display Mimir status
  ansible.builtin.debug:
    msg:
      - "Mimir successfully deployed to {{ inventory_hostname }}"
      - "Configuration: /etc/mimir/mimir-config.yml"
      - "Data directory: /var/lib/mimir"
      - "HTTP endpoint: http://localhost:{{ mimir_http_port }}"
      - "Metrics endpoint: http://localhost:{{ mimir_http_port }}/metrics"

- name: Flush handlers to restart Mimir before deploying rules
  ansible.builtin.meta: flush_handlers

- name: Wait for Mimir to be ready after potential restart
  ansible.builtin.uri:
    url: "http://localhost:{{ mimir_http_port }}/ready"
    method: GET
    status_code: 200
  retries: 10
  delay: 2
  register: mimir_ready_after_restart
  until: mimir_ready_after_restart.status == 200

- name: Deploy Mimir rules
  ansible.builtin.include_tasks: deploy-rules.yml
  tags:
    - mimir-rules
    - rules
