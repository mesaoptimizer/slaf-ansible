---
- name: Install Loki dependencies
  community.general.apk:
    name:
      - curl
      - ca-certificates
      - libcap
      - unzip
    state: present
    update_cache: true

- name: Create loki system group
  ansible.builtin.group:
    name: loki
    system: true
    state: present

- name: Create loki system user
  ansible.builtin.user:
    name: loki
    group: loki
    shell: /sbin/nologin
    home: /var/lib/loki
    createhome: true
    system: true
    state: present

- name: Create loki directories
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    owner: loki
    group: loki
    mode: "0750"
  loop:
    - /var/lib/loki
    - /var/lib/loki/wal
    - /var/lib/loki/tsdb-index
    - /var/lib/loki/tsdb-cache
    - /var/lib/loki/compactor
    - /etc/loki

- name: Download Loki binary
  block:
    - name: Get latest Loki release
      ansible.builtin.uri:
        url: https://api.github.com/repos/grafana/loki/releases/latest
        return_content: true
      register: loki_release
      check_mode: false

    - name: Select Loki asset name for Linux amd64
      ansible.builtin.set_fact:
        loki_asset_name: "{{ loki_release.json.assets | map(attribute='name') | select('match', '^loki-linux-amd64(\\.zip)?$') | list | first | default('') }}"

    - name: Extract download URL for Linux amd64
      ansible.builtin.set_fact:
        loki_download_url: "{{ loki_release.json.assets | selectattr('name', 'equalto', loki_asset_name) | map(attribute='browser_download_url') | first | default('') }}"
        loki_download_is_zip: "{{ loki_asset_name is search('\\.zip$') }}"

    - name: Fail if Loki download URL is missing
      ansible.builtin.fail:
        msg: "Unable to determine Loki download URL for linux-amd64."
      when: loki_download_url is not defined or loki_download_url == ""

    - name: Download Loki archive
      ansible.builtin.get_url:
        url: "{{ loki_download_url }}"
        dest: /tmp/loki-download
        mode: "0644"
      register: loki_archive_download

    - name: Ensure Loki unpack directory exists
      ansible.builtin.file:
        path: /tmp/loki-unpack
        state: directory
        mode: "0755"
      when: loki_download_is_zip | bool

    - name: Unarchive Loki download
      ansible.builtin.unarchive:
        src: /tmp/loki-download
        dest: /tmp/loki-unpack
        remote_src: true
      when: loki_download_is_zip | bool

    - name: Set Loki binary source
      ansible.builtin.set_fact:
        loki_binary_source: "{{ '/tmp/loki-unpack/loki-linux-amd64' if loki_download_is_zip | bool else '/tmp/loki-download' }}"

    - name: Install Loki binary
      ansible.builtin.copy:
        src: "{{ loki_binary_source }}"
        dest: /usr/local/bin/loki
        mode: "0755"
        owner: root
        group: root
        remote_src: true

- name: Retrieve AppRole credentials from Vault
  block:
    - name: Get AppRole credentials from Vault for loki
      ansible.builtin.uri:
        url: "{{ vault_addr }}/v1/secret/data/approle/loki"
        method: GET
        headers:
          X-Vault-Token: "{{ vault_token }}"
        status_code: 200
        validate_certs: false
      register: loki_approle_credentials_result
      check_mode: false

    - name: Set AppRole credentials from Vault
      ansible.builtin.set_fact:
        loki_vault_role_id: "{{ loki_approle_credentials_result.json.data.data.role_id }}"
        loki_vault_secret_id: "{{ loki_approle_credentials_result.json.data.data.secret_id }}"
        cacheable: true
      when: loki_approle_credentials_result.json.data.data.role_id is defined

- name: Retrieve S3 credentials from Vault using AppRole
  block:
    - name: Authenticate with Vault using AppRole
      ansible.builtin.uri:
        url: "{{ vault_addr }}/v1/auth/approle/login"
        method: POST
        body_format: json
        body:
          role_id: "{{ loki_vault_role_id }}"
          secret_id: "{{ loki_vault_secret_id }}"
        status_code: 200
        validate_certs: false
      register: loki_vault_auth_result
      check_mode: false

    - name: Retrieve S3 credentials from Vault
      ansible.builtin.uri:
        url: "{{ vault_addr }}/v1/secret/data/garage/loki/credentials"
        method: GET
        headers:
          X-Vault-Token: "{{ loki_vault_auth_result.json.auth.client_token }}"
        status_code: 200
        validate_certs: false
      register: loki_s3_credentials_result
      check_mode: false

    - name: Set S3 credentials fact
      ansible.builtin.set_fact:
        loki_s3_access_key: "{{ loki_s3_credentials_result.json.data.data.access_key_id }}"
        loki_s3_secret_key: "{{ loki_s3_credentials_result.json.data.data.secret_access_key }}"
        loki_s3_bucket: "{{ loki_s3_credentials_result.json.data.data.bucket_name | default('loki') }}"
        cacheable: true

- name: Retrieve Grafana Cloud Alertmanager credentials from Vault
  block:
    - name: Retrieve Grafana Cloud Alertmanager credentials
      ansible.builtin.uri:
        url: "{{ vault_addr }}/v1/{{ loki_grafanacloud_alertmanager_vault_path }}"
        method: GET
        headers:
          X-Vault-Token: "{{ loki_vault_auth_result.json.auth.client_token }}"
        status_code: 200
        validate_certs: false
      register: loki_grafanacloud_am_result
      check_mode: false

    - name: Set Grafana Cloud Alertmanager credentials
      ansible.builtin.set_fact:
        loki_grafanacloud_am_id: "{{ loki_grafanacloud_am_result.json.data.data.id }}"
        loki_grafanacloud_am_token: "{{ loki_grafanacloud_am_result.json.data.data.token }}"
        cacheable: true

- name: Generate Loki configuration
  ansible.builtin.template:
    src: loki-config.yml.j2
    dest: /etc/loki/loki-config.yml
    owner: loki
    group: loki
    mode: "0640"

- name: Create loki log file
  ansible.builtin.file:
    path: /var/log/loki.log
    state: touch
    owner: loki
    group: loki
    mode: "0644"
    modification_time: preserve
    access_time: preserve

- name: Create Loki OpenRC service
  ansible.builtin.template:
    src: loki.service.j2
    dest: /etc/init.d/loki
    mode: "0755"

- name: Enable and start Loki service
  ansible.builtin.service:
    name: loki
    state: started
    enabled: true

- name: Wait for Loki to be ready
  ansible.builtin.wait_for:
    host: localhost
    port: "{{ loki_http_port }}"
    delay: 2
    timeout: 60
    state: started

- name: Check Loki ready endpoint
  ansible.builtin.uri:
    url: "http://localhost:{{ loki_http_port }}/ready"
    method: GET
    status_code: 200
  retries: 10
  delay: 2
  register: loki_ready_result
  until: loki_ready_result.status == 200

- name: Verify Loki is running
  ansible.builtin.command: /usr/bin/pgrep -f loki
  register: loki_process
  changed_when: false
  failed_when: loki_process.rc != 0

- name: Display Loki status
  ansible.builtin.debug:
    msg:
      - "Loki successfully deployed to {{ inventory_hostname }}"
      - "Configuration: /etc/loki/loki-config.yml"
      - "Data directory: /var/lib/loki"
      - "HTTP endpoint: http://localhost:{{ loki_http_port }}"
      - "Metrics endpoint: http://localhost:{{ loki_http_port }}/metrics"

- name: Deploy Loki rules
  ansible.builtin.include_tasks: deploy-rules.yml
  tags:
    - loki-rules
    - rules
