---
# Main tasks for Grafana Alloy role

- name: Create Alloy group
  ansible.builtin.group:
    name: "{{ alloy_group }}"
    system: true
    state: present

- name: Create Alloy user
  ansible.builtin.user:
    name: "{{ alloy_user }}"
    group: "{{ alloy_group }}"
    system: true
    shell: /sbin/nologin
    home: "{{ alloy_data_dir }}"
    create_home: false
    state: present

- name: Add Alloy user to systemd-journal group (Debian)
  ansible.builtin.user:
    name: "{{ alloy_user }}"
    groups: systemd-journal
    append: true

- name: Create Alloy directories
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    owner: "{{ alloy_user }}"
    group: "{{ alloy_group }}"
    mode: "0750"
  loop:
    - "{{ alloy_data_dir }}"
    - "{{ alloy_config_dir }}"

# Installation is now handled by distro-specific tasks using official repos

- name: Generate Alloy configuration
  ansible.builtin.template:
    src: alloy-config.alloy.j2
    dest: "{{ alloy_config_file }}"
    owner: "{{ alloy_user }}"
    group: "{{ alloy_group }}"
    mode: "0640"
  notify: Restart alloy

# Include distro-specific tasks for service installation
- name: Include Debian/Ubuntu specific tasks
  ansible.builtin.include_tasks: install-debian.yml
  when: ansible_os_family == 'Debian'

- name: Enable and start Alloy service
  ansible.builtin.systemd:
    name: alloy
    state: started
    enabled: true

- name: Wait 30 seconds for service to stabilize
  ansible.builtin.pause:
    seconds: 30

- name: Check that Alloy service is still running
  ansible.builtin.service_facts:

- name: Verify Alloy service is active
  ansible.builtin.assert:
    that:
      - ansible_facts.services['alloy.service'] is defined
      - ansible_facts.services['alloy.service'].state == 'running'
    fail_msg: "Alloy service crashed after starting"
    success_msg: "Alloy service is running successfully"
