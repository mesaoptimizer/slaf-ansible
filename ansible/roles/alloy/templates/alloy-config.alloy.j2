// Generated by Ansible on {{ ansible_date_time.iso8601 }}
// Grafana Alloy configuration for {{ inventory_hostname }}

// ============================================================================
// LOGGING CONFIGURATION
// ============================================================================

logging {
  level  = "info"
  format = "logfmt"
}

// ============================================================================
// PROMETHEUS METRICS COLLECTION
// ============================================================================

// Node exporter-style metrics
prometheus.exporter.unix "node" {
  disable_collectors = ["mdadm", "nfs", "nfsd", "zfs"]
}

prometheus.scrape "node" {
  targets    = prometheus.exporter.unix.node.targets
  forward_to = [prometheus.remote_write.mimir.receiver]

  scrape_interval = "{{ alloy_scrape_interval }}"

  clustering {
    enabled = false
  }
}

// Remote write to Mimir
prometheus.remote_write "mimir" {
  endpoint {
    url = "{{ mimir_endpoint }}/api/v1/push"
  }

  external_labels = {
    instance = "{{ inventory_hostname }}",
{% for key, value in alloy_external_labels.items() %}
    {{ key }} = "{{ value }}",
{% endfor %}
  }
}

// ============================================================================
// LOG COLLECTION
// ============================================================================
// Log collection disabled - using metrics only
// To enable log collection to Loki, uncomment the configuration below

// ============================================================================
// EXTRA CONFIGURATION BLOCKS
// ============================================================================
{% for block in alloy_extra_config_blocks %}

{{ block }}
{% endfor %}
