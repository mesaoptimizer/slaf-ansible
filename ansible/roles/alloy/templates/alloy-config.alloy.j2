// Generated by Ansible on {{ ansible_date_time.iso8601 }}
// Grafana Alloy configuration for {{ inventory_hostname }}

// ============================================================================
// LOGGING CONFIGURATION
// ============================================================================

logging {
  level  = "info"
  format = "logfmt"
}

// ============================================================================
// PROMETHEUS METRICS COLLECTION
// ============================================================================

// Node exporter-style metrics
prometheus.exporter.unix "node" {
  disable_collectors = ["mdadm", "nfs", "nfsd", "zfs"]
}

prometheus.scrape "node" {
  targets    = prometheus.exporter.unix.node.targets
  forward_to = [prometheus.remote_write.mimir.receiver]

  scrape_interval = "{{ alloy_scrape_interval }}"

  clustering {
    enabled = false
  }
}

// Remote write to Mimir
prometheus.remote_write "mimir" {
  endpoint {
    url = "{{ mimir_endpoint }}/api/v1/push"
  }

  external_labels = {
    instance = "{{ inventory_hostname }}",
{% for key, value in alloy_external_labels.items() %}
    {{ key }} = "{{ value }}",
{% endfor %}
  }
}

// ============================================================================
// LOG COLLECTION
// ============================================================================

// Collect logs from system log files
loki.source.file "system_logs" {
  targets = [
{% if ansible_os_family == 'Alpine' %}
{% for log in alloy_log_paths_alpine %}
    {__path__ = "{{ log.path }}", log_type = "{{ log.log_type }}", instance = "{{ inventory_hostname }}"},
{% endfor %}
{% else %}
{% for log in alloy_log_paths_debian %}
    {__path__ = "{{ log.path }}", log_type = "{{ log.log_type }}", instance = "{{ inventory_hostname }}"},
{% endfor %}
{% endif %}
  ]
  forward_to = [loki.process.filter.receiver]
}

// Process and filter logs - keep only security-relevant entries
loki.process "filter" {
  forward_to = [loki.write.loki.receiver]

  // Extract timestamp if present in syslog format
  stage.regex {
    expression = "^(?P<timestamp>\\w+\\s+\\d+\\s+\\d+:\\d+:\\d+)\\s+(?P<hostname>\\S+)\\s+(?P<program>[^\\[\\]:]+)(?:\\[(?P<pid>\\d+)\\])?:?\\s*(?P<message>.*)$"
  }

  // Extract sudo command details
  stage.regex {
    expression = "(?P<sudo_user>\\S+)\\s+:.*COMMAND=(?P<sudo_command>.*)"
  }

  // Keep only security-relevant log lines:
  // - sudo commands
  // - root login/session events
  // - authentication failures
  // - service start/stop/restart
  // - critical errors
  stage.match {
    selector = "{} |~ \"(?i)(sudo|COMMAND=|session opened for user root|session closed for user root|authentication failure|Failed password|Accepted password|error|fail|started|stopped|restart)\""

    // Add severity label for important events
    stage.regex {
      expression = "(?i)(?P<severity>error|fail|critical|warning)"
    }

    stage.labels {
      values = {
        severity = "",
      }
    }

    // Store high-cardinality data in structured metadata (Loki 3.0+)
    stage.structured_metadata {
      values = {
        sudo_user    = "",
        sudo_command = "",
        program      = "",
        pid          = "",
      }
    }
  }

  // Drop all other log lines
  stage.match {
    selector = "{} !~ \"(?i)(sudo|COMMAND=|session opened for user root|session closed for user root|authentication failure|Failed password|Accepted password|error|fail|started|stopped|restart)\""
    action   = "drop"
  }

  // Add static labels
  stage.static_labels {
    values = {
      job = "alloy",
{% for key, value in alloy_external_labels.items() %}
      {{ key }} = "{{ value }}",
{% endfor %}
    }
  }
}

// Write logs to Loki
loki.write "loki" {
  endpoint {
    url = "{{ loki_endpoint }}/loki/api/v1/push"
  }

  external_labels = {
    instance = "{{ inventory_hostname }}",
  }
}

// ============================================================================
// EXTRA CONFIGURATION BLOCKS
// ============================================================================
{% for block in alloy_extra_config_blocks %}

{{ block }}
{% endfor %}
