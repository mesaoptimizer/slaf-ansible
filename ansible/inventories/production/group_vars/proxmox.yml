---
# Group variables for Proxmox hosts

# Proxmox-specific Alloy config blocks for PVE logs
alloy_extra_config_blocks:
  - |
    // Loki write endpoint
    loki.write "loki" {
      endpoint {
        url = "{{ loki_endpoint }}/loki/api/v1/push"
      }
      
      external_labels = {
        instance = "{{ inventory_hostname }}",
        env = "production",
      }
    }
  - |
    // Proxmox VE task logs (active tasks)
    loki.source.file "pve_tasks_active" {
      targets = [
        {__path__ = "/var/log/pve/tasks/active", log_type = "pve_tasks_active", instance = "{{ inventory_hostname }}"},
      ]
      forward_to = [loki.process.pve.receiver]
    }
  - |
    // Proxmox VE task index
    loki.source.file "pve_tasks_index" {
      targets = [
        {__path__ = "/var/log/pve/tasks/index*", log_type = "pve_tasks_index", instance = "{{ inventory_hostname }}"},
      ]
      forward_to = [loki.process.pve.receiver]
    }
  - |
    // Proxmox daemon logs from journal - pveproxy
    loki.source.journal "pve_proxy" {
      matches = "_SYSTEMD_UNIT=pveproxy.service"
      forward_to = [loki.process.pve.receiver]
      labels = {
        job = "proxmox",
        log_type = "pve_proxy",
        instance = "{{ inventory_hostname }}",
      }
    }
  - |
    // Proxmox daemon logs from journal - pvedaemon
    loki.source.journal "pve_daemon" {
      matches = "_SYSTEMD_UNIT=pvedaemon.service"
      forward_to = [loki.process.pve.receiver]
      labels = {
        job = "proxmox",
        log_type = "pve_daemon",
        instance = "{{ inventory_hostname }}",
      }
    }
  - |
    // Proxmox daemon logs from journal - pvescheduler
    loki.source.journal "pve_scheduler" {
      matches = "_SYSTEMD_UNIT=pvescheduler.service"
      forward_to = [loki.process.pve.receiver]
      labels = {
        job = "proxmox",
        log_type = "pve_scheduler",
        instance = "{{ inventory_hostname }}",
      }
    }
  - |
    // Process Proxmox logs
    loki.process "pve" {
      forward_to = [loki.write.loki.receiver]

      stage.static_labels {
        values = {
          job = "proxmox",
        }
      }
    }
