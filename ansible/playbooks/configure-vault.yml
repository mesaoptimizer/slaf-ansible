---
- name: Configure HashiCorp Vault AppRole for application
  hosts: lxc-hashicorpvault
  vars_prompt:
    - name: app_name
      prompt: "Application name (used for AppRole/policy naming)"
      private: false
  vars:
    vault_addr: "https://vault.lan.schlaefli.dev"
    vault_token: "{{ vault_token | default(lookup('env', 'VAULT_TOKEN')) }}"
    app_role_name: "{{ app_name }}-app"
    app_policy_name: "{{ app_name }}-s3-access"
    regenerate_secret_id: false
    store_secret_id_in_vault: true
    secret_id_storage_path: "secret/data/approle/{{ app_name }}"

  tasks:
    - name: Verify app_name is set
      ansible.builtin.assert:
        that:
          - app_name is defined
          - app_name | trim | length > 0
        fail_msg: "app_name must be set via survey"

    - name: Verify Vault token is set
      ansible.builtin.assert:
        that:
          - vault_token | length > 0
        fail_msg: "vault_token must be set via survey or VAULT_TOKEN env var"

    - name: Check enabled auth methods
      ansible.builtin.uri:
        url: "{{ vault_addr }}/v1/sys/auth"
        method: GET
        headers:
          X-Vault-Token: "{{ vault_token }}"
        status_code: 200
        validate_certs: false
      register: auth_methods_result

    - name: Enable AppRole auth method
      ansible.builtin.uri:
        url: "{{ vault_addr }}/v1/sys/auth/approle"
        method: POST
        headers:
          X-Vault-Token: "{{ vault_token }}"
        body_format: json
        body:
          type: approle
          description: "AppRole auth method for service authentication"
        status_code: [200, 204]
        validate_certs: false
      when: "'approle/' not in (auth_methods_result.json.data | default({}))"

    - name: "Create  AppRole {{ app_role_name }}"
      ansible.builtin.uri:
        url: "{{ vault_addr }}/v1/auth/approle/role/{{ app_role_name }}"
        method: POST
        headers:
          X-Vault-Token: "{{ vault_token }}"
        body_format: json
        body:
          token_type: batch
          token_ttl: "20m"
          token_max_ttl: "1h"
          secret_id_ttl: "24h"
          secret_id_num_uses: 0
          token_policies:
            - "{{ app_policy_name }}"
        status_code: [200, 204]
        validate_certs: false
      register: approle_create_result

    - name: "Create policy {{ app_policy_name }}"
      ansible.builtin.uri:
        url: "{{ vault_addr }}/v1/sys/policies/acl/{{ app_policy_name }}"
        method: POST
        headers:
          X-Vault-Token: "{{ vault_token }}"
        body_format: json
        body:
          policy: |
            path "secret/data/garage/{{ app_name }}/*" {
              capabilities = ["read", "list"]
            }
            path "auth/approle/role/{{ app_role_name }}/secret-id" {
              capabilities = ["update"]
            }
        status_code: [200, 204]
        validate_certs: false

    - name: "Get role id {{ app_role_name }}"
      ansible.builtin.uri:
        url: "{{ vault_addr }}/v1/auth/approle/role/{{ app_role_name }}/role-id"
        method: GET
        headers:
          X-Vault-Token: "{{ vault_token }}"
        status_code: 200
        validate_certs: false
      register: role_id_result

    - name: Check stored Secret ID in Vault
      ansible.builtin.uri:
        url: "{{ vault_addr }}/v1/{{ secret_id_storage_path }}"
        method: GET
        headers:
          X-Vault-Token: "{{ vault_token }}"
        status_code: [200, 404]
        validate_certs: false
      register: stored_secret_result
      when: store_secret_id_in_vault | bool

    - name: Set existing Secret ID fact
      ansible.builtin.set_fact:
        existing_secret_id: "{{ stored_secret_result.json.data.data.secret_id }}"
      when:
        - store_secret_id_in_vault | bool
        - stored_secret_result.status == 200
        - stored_secret_result.json.data.data.secret_id is defined

    - name: "Generate Secred ID{{ app_role_name }}"
      ansible.builtin.uri:
        url: "{{ vault_addr }}/v1/auth/approle/role/{{ app_role_name }}/secret-id"
        method: POST
        headers:
          X-Vault-Token: "{{ vault_token }}"
        body_format: json
        body: {}
        status_code: 200
        validate_certs: false
      register: secret_id_result
      when:
        - regenerate_secret_id | bool or existing_secret_id is not defined

    - name: Set Secret ID value from Vault
      ansible.builtin.set_fact:
        secret_id_value: "{{ existing_secret_id }}"
      when: existing_secret_id is defined

    - name: Set Secret ID value from generation
      ansible.builtin.set_fact:
        secret_id_value: "{{ secret_id_result.json.data.secret_id }}"
      when: secret_id_result.json.data.secret_id is defined

    - name: Store Secret ID in Vault
      ansible.builtin.uri:
        url: "{{ vault_addr }}/v1/{{ secret_id_storage_path }}"
        method: POST
        headers:
          X-Vault-Token: "{{ vault_token }}"
        body_format: json
        body:
          data:
            secret_id: "{{ secret_id_value }}"
            role_id: "{{ role_id_result.json.data.role_id }}"
        status_code: [200, 204]
        validate_certs: false
      when:
        - store_secret_id_in_vault | bool
        - secret_id_value is defined

    - name: "Display AppRole configuration for {{ app_name }}"
      ansible.builtin.debug:
        msg:
          - "AppRole successfully configured in Vault for {{ app_name }}"
          - "AppRole: {{ app_role_name }}"
          - "Policy: {{ app_policy_name }}"
          - "Role ID: {{ role_id_result.json.data.role_id | default('(skipped in check mode)') }}"
          - "Secret ID: {{ secret_id_value | default('(using existing from Vault)') }}"
          - ""
          - "Credentials stored securely in Vault at:"
          - "  - {{ secret_id_storage_path }}"
          - ""
          - "Deployment playbooks (loki.yml, mimir.yml, etc.) will retrieve"
          - "credentials from Vault using the AppRole authentication method."

    - name: "Verify Approle setup {{ app_role_name }}"
      ansible.builtin.uri:
        url: "{{ vault_addr }}/v1/auth/approle/role/{{ app_role_name }}"
        method: GET
        headers:
          X-Vault-Token: "{{ vault_token }}"
        status_code: 200
        validate_certs: false
      register: approle_verify_result

    - name: Display AppRole configuration
      ansible.builtin.debug:
        var: approle_verify_result.json.data
      when: approle_verify_result.json is defined
