---
- name: Configure HashiCorp Vault AppRole for application
  hosts: lxc-hashicorpvault
  vars_prompt:
    - name: app_name
      prompt: "Application name (used for AppRole/policy naming)"
      private: false
  vars:
    vault_addr: "https://vault.lan.schlaefli.dev"
    vault_token: "{{ vault_token | default(lookup('env', 'VAULT_TOKEN')) }}"
    app_role_name: "{{ app_name }}-app"
    app_policy_name: "{{ app_name }}-s3-access"
    app_role_id_file: "/tmp/{{ app_name }}-role-id.txt"
    app_secret_id_file: "/tmp/{{ app_name }}-secret-id.txt"
    regenerate_secret_id: false
    store_secret_id_in_vault: true
    secret_id_storage_path: "secret/data/approle/{{ app_name }}"

  tasks:
    - name: Verify app_name is set
      assert:
        that:
          - app_name is defined
          - app_name | trim | length > 0
        fail_msg: "app_name must be set via survey"

    - name: Verify Vault token is set
      assert:
        that:
          - vault_token | length > 0
        fail_msg: "vault_token must be set via survey or VAULT_TOKEN env var"

    - name: Check enabled auth methods
      uri:
        url: "{{ vault_addr }}/v1/sys/auth"
        method: GET
        headers:
          X-Vault-Token: "{{ vault_token }}"
        status_code: 200
        validate_certs: false
      register: auth_methods_result

    - name: Enable AppRole auth method
      uri:
        url: "{{ vault_addr }}/v1/sys/auth/approle"
        method: POST
        headers:
          X-Vault-Token: "{{ vault_token }}"
        body_format: json
        body:
          type: approle
          description: "AppRole auth method for service authentication"
        status_code: [200, 204]
        validate_certs: false
      when: "'approle/' not in (auth_methods_result.json.data | default({}))"

    - name: "Create {{ app_role_name }} AppRole"
      uri:
        url: "{{ vault_addr }}/v1/auth/approle/role/{{ app_role_name }}"
        method: POST
        headers:
          X-Vault-Token: "{{ vault_token }}"
        body_format: json
        body:
          token_type: batch
          token_ttl: "20m"
          token_max_ttl: "1h"
          secret_id_ttl: "24h"
          secret_id_num_uses: 0
          token_policies:
            - "{{ app_policy_name }}"
        status_code: [200, 204]
        validate_certs: false
      register: approle_create_result

    - name: "Create {{ app_policy_name }} policy"
      uri:
        url: "{{ vault_addr }}/v1/sys/policies/acl/{{ app_policy_name }}"
        method: POST
        headers:
          X-Vault-Token: "{{ vault_token }}"
        body_format: json
        body:
          policy: |
            path "secret/data/garage/{{ app_name }}/*" {
              capabilities = ["read", "list"]
            }
            path "auth/approle/role/{{ app_role_name }}/secret-id" {
              capabilities = ["update"]
            }
        status_code: [200, 204]
        validate_certs: false

    - name: "Get {{ app_role_name }} Role ID"
      uri:
        url: "{{ vault_addr }}/v1/auth/approle/role/{{ app_role_name }}/role-id"
        method: GET
        headers:
          X-Vault-Token: "{{ vault_token }}"
        status_code: 200
        validate_certs: false
      register: role_id_result

    - name: Check stored Secret ID in Vault
      uri:
        url: "{{ vault_addr }}/v1/{{ secret_id_storage_path }}"
        method: GET
        headers:
          X-Vault-Token: "{{ vault_token }}"
        status_code: [200, 404]
        validate_certs: false
      register: stored_secret_result
      when: store_secret_id_in_vault | bool

    - name: Set existing Secret ID fact
      set_fact:
        existing_secret_id: "{{ stored_secret_result.json.data.data.secret_id }}"
      when:
        - store_secret_id_in_vault | bool
        - stored_secret_result.status == 200
        - stored_secret_result.json.data.data.secret_id is defined

    - name: Check for existing Secret ID file
      stat:
        path: "{{ app_secret_id_file }}"
      become: false
      delegate_to: localhost
      register: secret_id_file_stat

    - name: "Generate {{ app_role_name }} Secret ID"
      uri:
        url: "{{ vault_addr }}/v1/auth/approle/role/{{ app_role_name }}/secret-id"
        method: POST
        headers:
          X-Vault-Token: "{{ vault_token }}"
        body_format: json
        body: {}
        status_code: 200
        validate_certs: false
      register: secret_id_result
      when:
        - regenerate_secret_id | bool or (secret_id_file_stat.stat.exists | default(false) == false)
        - existing_secret_id is not defined

    - name: Set Secret ID value from Vault
      set_fact:
        secret_id_value: "{{ existing_secret_id }}"
      when: existing_secret_id is defined

    - name: Set Secret ID value from generation
      set_fact:
        secret_id_value: "{{ secret_id_result.json.data.secret_id }}"
      when: secret_id_result.json.data.secret_id is defined

    - name: Store Secret ID in Vault
      uri:
        url: "{{ vault_addr }}/v1/{{ secret_id_storage_path }}"
        method: POST
        headers:
          X-Vault-Token: "{{ vault_token }}"
        body_format: json
        body:
          data:
            secret_id: "{{ secret_id_value }}"
            role_id: "{{ role_id_result.json.data.role_id }}"
        status_code: [200, 204]
        validate_certs: false
      when:
        - store_secret_id_in_vault | bool
        - secret_id_result.json.data.secret_id is defined

    - name: "Write AppRole credentials for {{ app_name }}"
      block:
        - name: Write Role ID to file
          copy:
            content: "{{ role_id_result.json.data.role_id }}"
            dest: "{{ app_role_id_file }}"
            mode: "0600"
          become: false
          delegate_to: localhost
          when: role_id_result.json.data.role_id is defined

        - name: Write Secret ID to file
          copy:
            content: "{{ secret_id_value }}"
            dest: "{{ app_secret_id_file }}"
            mode: "0600"
          become: false
          delegate_to: localhost
          when:
            - secret_id_value is defined
            - regenerate_secret_id | bool or (secret_id_file_stat.stat.exists | default(false) == false)

        - name: Display AppRole credentials
          debug:
            msg:
              - "AppRole successfully configured in Vault for {{ app_name }}"
              - "AppRole: {{ app_role_name }}"
              - "Policy: {{ app_policy_name }}"
              - "Role ID: {{ role_id_result.json.data.role_id | default('(skipped in check mode)') }}"
              - "Secret ID: {{ secret_id_result.json.data.secret_id | default('(skipped in check mode)') }}"
              - "Credentials saved to:"
              - "  - {{ app_role_id_file }}"
              - "  - {{ app_secret_id_file }}"
              - "Keep these files safe for {{ app_name }}.yml playbook deployment"

    - name: "Verify {{ app_role_name }} AppRole setup"
      uri:
        url: "{{ vault_addr }}/v1/auth/approle/role/{{ app_role_name }}"
        method: GET
        headers:
          X-Vault-Token: "{{ vault_token }}"
        status_code: 200
        validate_certs: false
      register: approle_verify_result

    - name: Display AppRole configuration
      debug:
        var: approle_verify_result.json.data
      when: approle_verify_result.json is defined
