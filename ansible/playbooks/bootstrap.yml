---
- name: Bootstrap hosts
  hosts: monitoring:dns:security:media
  gather_facts: false
  tasks:
    - name: Try to gather facts (may fail on fresh hosts)
      ansible.builtin.setup:
      ignore_errors: true
      register: facts_result

    - name: Detect OS when facts failed (Debian)
      ansible.builtin.raw: command -v apt-get
      register: apt_check
      failed_when: false
      changed_when: false
      when: facts_result.failed

    - name: Install Python on Debian/Ubuntu
      ansible.builtin.raw: >
        apt-get update &&
        apt-get install -y python3 python3-pip python3-apt sudo ca-certificates curl wget gnupg lsb-release
      register: apt_install
      changed_when: "'Unpacking' in apt_install.stdout or 'Setting up' in apt_install.stdout"
      when: >
        (facts_result.failed and apt_check.rc == 0) or
        (not facts_result.failed and ansible_os_family == "Debian")

    - name: Gather facts (now that Python is installed)
      ansible.builtin.setup:

    - name: Ping hosts
      ansible.builtin.ping:

    - name: Install essentials on Debian/Ubuntu
      ansible.builtin.apt:
        name:
          - curl
          - wget
          - ca-certificates
          - gnupg
        state: present
        update_cache: true
      when: ansible_os_family == "Debian"

    - name: Update system packages (Debian/Ubuntu)
      ansible.builtin.apt:
        upgrade: dist
        update_cache: true
      when: ansible_os_family == "Debian"
